<!DOCTYPE html>
<html>
	<head>
		<title>Mi tienda</title>
		<meta charset="utf-8">
	</head>
	<style>
		h1 {
				float: right;
				padding-top: 20px;
				font-family: Collegiate-Normal;
			}
			#cabecera {
				background-color: white;
				height: 110px;
				font-size:250%;
				background-image: url("logo.jpg")
			}
			#titulo2{
				color:blue;
				font-weight: bold;
			}
			#formulario {
				background-color: white;
			}
			#nomb {
				padding-left: 100px;
			}
			#apell {
				float: right;
				margin-right: 150px;
			}
			#ed {
				margin-top: 10px;
				padding-left: 100px;
			}
			#direc {
				float: right;
				margin-top: 10px;
				margin-right: 150px;
			}
			#correo {
				margin-top: 10px;
				padding-left: 100px;
			}
			#tel {
				float: right;
				margin-top: 10px;
				margin-right: 150px;
			}
			#prov {
				padding-left: 100px;
				margin-top: 10px;
			}
			#prod {
				float: right;
				margin-top: 10px;
				margin-right: 150px;
				
			}
			#productos {
				height:100px;
				background-color: #FAED92;
				display: flex;
				align-items: center;
				border-color: black;
				border-style:solid;
			}
			#datosPersonales {
				border-color: black;
				border-style:solid;
				background-color: #FAED92;
			}
			#can {
				margin-top: 10px;
			}
			#term {
				clear: right;
				margin-top: 30px;
				padding-left: 100px;
			}
			#botones {
				margin-top: 50px;
				text-align: center;
			}
			#color {
				
				padding-right: 275px;
				color: red;
			}
			body {
				background-color: lightyellow;
				font-family: sans-serif;
			}
			label {
				color: maroon;
				display: block;
				padding: 5px;
			}
			img {
				float: left;
				width: 100px;
				height: 100px;
			}
			#titulo {
				background-color: #F4A460;
				padding-top: 10px;
				font-size:150%;
			}

	</style>
	<body>	
		<script>
			
			//array bidimensional vacio que almacenará los pedidos que añado
			const pedidos= [];

			//funcion añadir linea y sus verificaciones
			function anadirLinea(){

				const producto = document.getElementById('producto');
				// Obtener el valor de cantidad
				const cantidad = parseInt(document.getElementById('cantidad').value);
				// Convertir el valor del producto a un número entro (precio)
				const precio = parseFloat(producto.value);
				//console.log("Producto seleccionado:", producto.options[producto.selectedIndex].text);
    			//console.log("Cantidad ingresada:", cantidad);
    			//console.log("Precio del producto:", precio);
				//comprobamos que ha elegido al menos uno válido y mayor a 0
					if (producto.value !== "--Producto--" && !isNaN(precio) && cantidad > 0) {
						//para añadir una linea al arrary 'pedidos' con el push que guarda el nombre, cantidad y precio total
						pedidos.push([producto.options[producto.selectedIndex].text,cantidad,precio*cantidad]);
						//creamos una alerta
						alert("Producto añadido correctamente");
					}else{
						alert("selecciona al menos un producto y una cantidad mayor a 0");
					}
			}			
			// Función principal que valida las funciones de todo el formulario
			function validarFormulario() {
				console.log('Formulario enviado, validando...');
				 // Validar que haya al menos un producto en el pedido
				 if (pedidos.length === 0) {
					alert("Debe añadir al menos un producto al pedido.");
					return false;
				}
				if (!validarNombreApellidos()  || !validarDireccion()|| !validarCodigoPostal() || !validarProvincia() || 
				!validarTelefono() || !validarEmail() ||!validarFecha() || !validarFormaPago() || !validarTerminos()) {
					return false;
				}
				//evita que el formulario se envíe automáticamente para abrir la ventana emergente de confirmación
					mostrarDatosEnPopup();
					return false;				
        	}
			//validaciones de nombre y apellidos
			function validarNombreApellidos(){
				const nombre=document.getElementById('nombre').value.trim();
				const apellidos= document.getElementById('apellidos').value.trim();
				if(nombre === "" || apellidos === ""){
					alert("es necesario rellenar con nombre y apellidos");
				return false;
				}
				return true;
			}
	
			//validacion de telefono que empiece por 6,7 o 9
			function validarTelefono(){
				const telefono=document.getElementById('telefono').value.trim();
		    /* expresion regular:
			^ — Inicio de la cadena solo uno de los tres -> [679]{1} 
			[0-9]{8} siguiente solo  8 dígitos, pueden ser cualquier número entre 0 y 9
			$ — Fin de la cadena, asegura que no haya +  9 dígitos.*/
				const modeloTelefono= /^[679]{1}[0-9]{8}$/;
				if (!modeloTelefono.test(telefono)){

					alert("El teléfono debe tener 9 dígitos y empezar por 6, 7 o 9.");
					return false;
				}
				return true;
			}

			//validacion de e-mail
			function validarEmail(){
				const email = document.getElementById('email').value.trim();
		    /*expresion regular:^ — Inicio de la cadena con carácteres de a-z, A-Z, 0-9, _ , -
			+@   	a-z, A-Z, 0-9, _ , - */
			//. y mínimo una longitud de dos caracteres que cumplan los mismos requisitos --> a-z, A-Z, 0-9 
				const emailOk = !/^[\w.-]+@[\w.-]+\.[a-zA-Z]{2,}$/;
				//compruebo que el campo no está vacio
				if (email === ""){
					alert("Es necesario rellenar este campo");
					return false;
				}
				//compruebo con la expresion regular que cumpla con el formato
				if(!emailOk.test(email)){
					alert("Correo electónico no válido");
					return false;
				}
				return true;
			}
			
			// validar que se ha seleccionado una provincia
			function validarProvincia() {
				const provincia = document.getElementById('provincia').value;
				// Comprobar si la provincia es la opción predeterminada y por lo tanto no se ha elegido
				if (provincia === "--Provincia--") {
					alert("Debe seleccionar una provincia.");
					return false;
				}
				return true;
			}
			//valida el campo fecha
			function validarFecha() {
				const fecha = document.getElementById('fecha').value.trim();
				//comprobar que la fecha no está vacía
				if (fecha === "") {
					alert("Es necesario rellenar la fecha de entrega.");
					return false;
				}
				/*expresion regular para el formato de la fecha empezando por los dias y las combinaciones luego separa 
				el mes con \/ se hacen combinaciones (meses que empiezan por 0[acompañado de numeros del 1-9]) o el 11 y 12 y por
				ultimo el año verifica que empiece por 20 y seguido de cualquier numero decimal (0,9)
				*/
				const fechaOk=/^(0[1-9]|[12][0-9]|3[01])\/(0[1-9]|1[0-2])\/20\d{2}$/;
				if(!fechaOk.test(fecha)){
					alert("formato de fecha inválido ejemplo: 12/07/2024")
					return false;
				}
				
				//split para separar con barra
				const fechaArray = fecha.split("/");
				//separamos la fecha en tres partes(dia, mes y año) segun su índice
				const dia = parseInt(fechaArray[0]);
				const mes = parseInt(fechaArray[1]);
				const anio = parseInt(fechaArray[2]);

				//En Date, el mes empieza desde 0 para enero, por lo que se debe restar 1 al valor de mes.
				const fechaIngresada = new Date(anio,mes-1,dia);
				const fechaActual = new Date();
				//validar que la fecha ingresada no sea anterior a la fecha actual 
				if(fechaIngresada<fechaActual){
					alert("La fecha debe ser posterior a la fecha de pedido");
					return false;
				}				
				return true;
			}
			//validacion de direccion
			function validarDireccion(){
				const direccion=document.getElementById('direccion').value.trim();
				if (direccion === ""){
					alert("Es necesario rellenar el campo dirección");
					return false
				}
				return true;
			}
			//validar codigo postal
			function validarCodigoPostal(){
				const codPostal=document.getElementById('codigo').value.trim();
				/*expresion regular para validar el correo numeros del 0-9 y de longitud 5*/
				const codOk = /^[0-9]{5}$/;
				// Verificar si el campo está vacío
				if (codPostal === "") {
					alert("El campo de código postal no puede estar vacío.");
					return false;
				}
				
				//verificar que cumple con la expresion regular
					if (!codOk.test(codPostal)){
						alert("Revise el codigo postal");
						return false;
					}
					return true;
			}
			function validarFormaPago() {
				const pago1 = document.getElementById('fpago1').checked;
				const pago2 = document.getElementById('fpago2').checked;
				const pago3 = document.getElementById('fpago3').checked;

				// Verifica que ninguno esté seleccionado; si es así, muestra la alerta
				if (!pago1 && !pago2 && !pago3) {
					alert("Debe seleccionar una forma de pago.");
					return false;
				}
				return true;
			}
			//guardarnos la forma de pago para la ventana emergente
			function obtenerFormaDePago() {
				if (document.getElementById('fpago1').checked) {
					return 'Contrareembolso';
				} else if (document.getElementById('fpago2').checked) {
					return 'Visa';
				} else if (document.getElementById('fpago3').checked) {
					return 'Transferencia';
				} else {
					return 'No seleccionada';
				}
			}

			function validarTerminos(){
				const terminosAcep = document.getElementById('terminos').checked;
				if(!terminosAcep){
					alert("Debe aceptar los términos");
					return false
				}
				return true;
			}
			function convertirMayusculas(campo) {
				const input = document.getElementById(campo);
				input.value = input.value.toUpperCase();
			}
			function mostrarDatosEnPopup() {
				const nombre = document.getElementById('nombre').value;
				const apellidos = document.getElementById('apellidos').value;
				const totalPedido = pedidos.reduce((total, pedido) => total + pedido[2], 0);
				const formaDePago = obtenerFormaDePago(); 


				// Crear una lista de productos en diferentes líneas
				const productosPedidosHTML = pedidos.map(
					pedido => `<ol>Producto: ${pedido[0]} Cantidad: ${pedido[1]} Total línea: ${pedido[2]}€</ol>`
				).join('');

				const datos = `
					<h1>Resumen del pedido:</h1>
					<p>Nombre: ${nombre}</p>
					<p>Apellidos: ${apellidos}</p>
					<p>Dirección: ${document.getElementById('direccion').value}</p>
					<p>Código Postal: ${document.getElementById('codigo').value}</p>
					<p>Provincia: ${document.getElementById('provincia').value}</p>
					<p>Teléfono: ${document.getElementById('telefono').value}</p>
					<p>Email: ${document.getElementById('email').value}</p>
					<p>Fecha Entrega: ${document.getElementById('fecha').value}</p>
					<p>Forma de pago:${formaDePago}</p>
					
					<h3>Productos pedidos:</h3>
					<p>
						${productosPedidosHTML}
					</p>
					<p><strong>Total pedido: ${totalPedido}€</strong></p>
					<button onclick="window.opener.confirmarPedido(); window.close();">Es correcto</button>
					<button onclick="window.opener.cancelarPedido(); window.close();">No es correcto</button>
				`;

				// Crear una ventana emergente y cargar el contenido HTML
				const popup = window.open("", "popup", "width=400,height=400");
				popup.document.open();
				popup.document.write(datos);
				popup.document.close();
			}
			// Si el usuario confirma el pedido
			function confirmarPedido() {
			alert("Gracias por su compra");
			window.close(); // Cerrar la ventana emergente
            }

            // Si el usuario cancela el pedido
			function cancelarPedido() {
				alert("Intente realizar el pedido de nuevo");
				window.close(); // Cerrar la ventana emergente
			}

			// Escuchar el evento de envío del formulario
			document.addEventListener('DOMContentLoaded', function () {
				const formulario = document.querySelector('form');
				formulario.addEventListener('submit', function (event) {
					if (!validarFormulario()) {
						event.preventDefault(); // Prevenir el envío del formulario si hay errores
					}
				});
			});
			
		</script>

<div id="formulario">
				<form name ="formularioContacto"  onsubmit="return validarFormulario()">
					<p id="titulo" align="center">
						FORMULARIO PEDIDO
					</p>
					<div id="productos">
					<table>
					<tr><td><p id="titulo2"> Añadir productos:</p></td></tr>
					<tr><td>
					<div id="prod">
							<span>Producto:</span>
								<select id="producto">
									<option>--Producto--</option>
									<option value="10">Jamon York(10€)</option>
									<option value="12">Chorizo(12€)</option>
									<option value="13">Morcilla(13€)</option>
									<option value="14">Lomo(14€)</option>
									<option value="8">Pavo(8€)</option>
									<option value="20">Jamon(20€)</option>
								</select> 
						</div></td>
						<td>
							<span>Cantidad:</span>
							<input type="number" id="cantidad" value=0>		
							</td><td><input type="button" value="Añadir línea pedido" id="btnAnadir" onclick="anadirLinea()"></td></tr>
					
					</table>
					</div>
					<div id="datosPersonales">
					<table>
					<tr><td><p id="titulo2"> Datos envío:</p></td></tr>
					<tr><td><div id="apell">
						<span>Apellidos:</span>
							<input id="apellidos" type="text" name="apellidos" onblur="convertirMayusculas('apellidos')" />
					</div>
					</td>
					<td><div id="nomb">
					<span>Nombre:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> 
							<input id="nombre" type="text" name="nombre" onblur="convertirMayusculas('nombre')"/>

					</div>
					</td></tr>
					<tr><td><div id="direc">
						<span>Direccion:</span>
							<input id="direccion" type="text" name="direccion" />
					
					</div>
					</td>
					<td><div id="ed">
						<span>Cod.Postal:</span>
							<input id="codigo" type="text" name="codigo" />
						
					</div>
					</td>
					<td><div id="prov">
						<span>Provincia:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
							<select id="provincia">
								<option>--Provincia--</option>
								<option>Madrid</option>
								<option>Barcelona</option>
								<option>Sevilla</option>
							</select> </label></div></tr>
					<tr><td><div id="tel">
						<span>Teléfono:</span>
							<input id="telefono" type="text" name="telefono" />

					</div>
					</td>
					<td><div id="correo">
					<span>E-mail:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
							<input id="email" type="text" name="email" />

					</div>
					</td>
					<td><div id="correo" >
					<span>Fecha entrega:</span>
					<input id="fecha" type="text" name="fecha" /></td></div></tr>
					
					<tr><td>
						
					<tr><td><div id="can">Forma de pago:
								<input type="radio" id="fpago1" name="fpago" value="Contrareembolso"> Contrareembolso
								<input type="radio" id="fpago2" name="fpago" value="Visa"> Visa
								<input type="radio" id="fpago3" name="fpago" value="Transferencia"> Transferencia
					</div></td></tr>
					<tr><td>
					<div id="term">
							<input id="terminos" type="checkbox" name="terminos" />
							Acepta los terminos de condicion de compra.
					</div></td></tr>
					
					<tr><td><div id="botones">
							<input type="submit" value="Enviar" >
							<input type="reset" value="Cancelar">				
					</div></td></tr>
					</table>
					</div>
				</form>
			</div>
		</div>
	</body>
</html>